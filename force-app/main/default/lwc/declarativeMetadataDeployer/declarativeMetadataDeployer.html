<!--
  @description       : 
  @author            : jamesperram@gmail.com
  @group             : 
  @last modified on  : 07-30-2025
  @last modified by  : jamesperram@gmail.com
-->
<template>
    <lightning-card title="Metadata Deployer" icon-name="standard:environment_hub">
        <!-- Loading spinner -->
        <div if:true={isLoading} class="slds-is-relative">
            <lightning-spinner alternative-text="Loading" size="medium"></lightning-spinner>
        </div>
        
        <div class="slds-p-around_medium">
            <!-- Search and Filter Section -->
            <div class="slds-grid slds-gutters">
                <div class="slds-col slds-size_1-of-3">
                    <lightning-combobox
                        label="Select Metadata Type"
                        value={selectedMetadataType}
                        options={metadataTypeOptions}
                        onchange={handleTypeChange}
                    ></lightning-combobox>
                </div>
                <div class="slds-col slds-size_2-of-3">
                    <lightning-input 
                        type="search" 
                        label="Search Metadata" 
                        value={searchTerm}
                        onchange={handleSearchChange}
                        disabled={isSearchDisabled}
                    ></lightning-input>
                </div>
            </div>
            
            <!-- Search Results Table - Now with row selection -->
            <div if:true={hasSearched} class="slds-m-top_medium">
                <h2 class="slds-text-heading_medium slds-m-bottom_small">Search Results</h2>
                <lightning-datatable
                    key-field="id"
                    data={metadataResults}
                    columns={columns}
                    onrowselection={handleMetadataRowSelection}
                    selected-rows={selectedRows}
                ></lightning-datatable>
            </div>
            
            <!-- Deployment Configuration Section -->
            <div class="slds-m-top_large">
                <h2 class="slds-text-heading_medium">Deployment Information</h2>
                <div class="slds-box slds-theme_default">
                    <div class="slds-grid slds-gutters">
                        <div class="slds-col">
                            <lightning-input 
                                label="Deployment Name" 
                                required
                                value={deploymentName}
                                onchange={handleDeploymentNameChange}
                            ></lightning-input>
                        </div>
                        <div class="slds-col">
                            <lightning-combobox
                                label="Test Level"
                                value={testLevel}
                                options={testLevelOptions}
                                onchange={handleTestLevelChange}
                            ></lightning-combobox>
                        </div>
                    </div>
                    
                    <div class="slds-m-top_medium">
                        <lightning-textarea 
                            label="Deployment Comments"
                            value={deploymentComments}
                            onchange={handleDeploymentCommentsChange}
                        ></lightning-textarea>
                    </div>
                    
                    <div class="slds-grid slds-gutters slds-m-top_medium">
                        <div class="slds-col">
                            <lightning-input 
                                type="checkbox" 
                                label="Validate Only (No Deployment)" 
                                checked={checkOnly}
                                onchange={handleCheckOnlyChange}
                            ></lightning-input>
                        </div>
                        <div class="slds-col">
                            <lightning-input 
                                type="checkbox" 
                                label="Rollback On Error" 
                                checked={rollbackOnError}
                                onchange={handleRollbackChange}
                            ></lightning-input>
                        </div>
                        <div class="slds-col">
                            <lightning-input 
                                type="checkbox" 
                                label="Ignore Warnings" 
                                checked={ignoreWarnings}
                                onchange={handleIgnoreWarningsChange}
                            ></lightning-input>
                        </div>
                    </div>
                    
                    <!-- Selected Components Table with Comments -->
                    <div class="slds-m-top_medium">
                        <h3 class="slds-text-heading_small">Selected Components</h3>
                        <template if:true={selectedComponents.length}>
                            <lightning-datatable
                                key-field="id"
                                data={selectedComponents}
                                columns={selectedColumns}
                                hide-checkbox-column
                                onrowaction={handleRowAction}
                                oncellchange={handleCellChange}
                            ></lightning-datatable>
                        </template>
                        <template if:false={selectedComponents.length}>
                            <div class="slds-box slds-theme_shade slds-m-top_x-small">
                                <p class="slds-text-align_center">No components selected for deployment</p>
                            </div>
                        </template>
                    </div>
                    
                    <div class="slds-m-top_medium slds-align_absolute-center">
                        <lightning-button 
                            label="Deploy Components"
                            variant="brand"
                            onclick={handleDeploy}
                            disabled={isDeployButtonDisabled}
                        ></lightning-button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Comment Edit Modal -->
        <template if:true={editingComment}>
            <section role="dialog" tabindex="-1" class="slds-modal slds-fade-in-open">
                <div class="slds-modal__container">
                    <header class="slds-modal__header">
                        <h2 class="slds-text-heading_medium">Edit Deployment Comment</h2>
                        <button class="slds-button slds-button_icon slds-modal__close" onclick={closeCommentModal}>
                            <lightning-icon icon-name="utility:close" size="small"></lightning-icon>
                            <span class="slds-assistive-text">Close</span>
                        </button>
                    </header>
                    <div class="slds-modal__content slds-p-around_medium">
                        <lightning-textarea
                            label="Comment"
                            value={currentEditCommentValue}
                            onchange={handleCommentChange}
                        ></lightning-textarea>
                    </div>
                    <footer class="slds-modal__footer">
                        <lightning-button 
                            label="Cancel" 
                            onclick={closeCommentModal} 
                            class="slds-m-right_x-small"
                        ></lightning-button>
                        <lightning-button 
                            label="Save" 
                            variant="brand" 
                            onclick={saveComment}
                        ></lightning-button>
                    </footer>
                </div>
            </section>
            <div class="slds-backdrop slds-backdrop_open"></div>
        </template>
    </lightning-card>
</template>